{% extends "base.html" %}

{% block title %}Gladney Analytics Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen flex w-full bg-gray-50">
     Sidebar 
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-sidebar border-r border-sidebar-border z-40 lg:relative lg:z-auto transition-transform duration-300">
        <div class="h-full flex flex-col">
             Sidebar Header 
            <div class="h-16 flex items-center justify-between px-4 border-b border-sidebar-border">
                <div class="flex items-center gap-3">
                    <img src="{{ url_for('static', filename='logo-em-cima.svg') }}" alt="Upstart13" class="h-10 w-10 rounded-lg object-cover">
                    <div class="flex flex-col">
                        <h2 class="text-base font-semibold text-sidebar-foreground">Gladney</h2>
                        <p class="text-xs text-muted-foreground">Analytics Dashboard</p>
                    </div>
                </div>
            </div>

             Sidebar Content 
            <div class="flex-1 overflow-y-auto px-2 py-4">
                <div class="space-y-2">
                     Dashboard Section 
                    <div class="group">
                        <div class="flex items-center gap-3 p-3 rounded-lg hover:bg-sidebar-accent transition-colors cursor-pointer" onclick="toggleSection('dashboard-section')">
                            <svg class="h-5 w-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span class="font-medium">Dashboard</span>
                            <svg class="ml-auto h-4 w-4 transition-transform group-hover:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                        <div id="dashboard-section" class="ml-6 space-y-1 mt-2">
                            <div class="p-2 rounded-lg hover:bg-sidebar-accent transition-colors cursor-pointer" onclick="setActivePage('expectant_mother')">
                                <span class="text-sm">Expectant Mother</span>
                            </div>
                            <div class="p-2 rounded-lg hover:bg-sidebar-accent transition-colors cursor-pointer" onclick="setActivePage('gladney_business')">
                                <span class="text-sm leading-tight">Gladney Business<br>Performance</span>
                            </div>
                            <div class="p-2 rounded-lg hover:bg-sidebar-accent transition-colors cursor-pointer" onclick="setActivePage('page_traffic')">
                                <span class="text-sm">Page Traffic Monitor</span>
                            </div>
                        </div>
                    </div>

                     Information Section 
                    <div class="group">
                        <div class="flex items-center gap-3 p-3 rounded-lg hover:bg-sidebar-accent transition-colors cursor-pointer" onclick="toggleSection('info-section')">
                            <svg class="h-5 w-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-medium">Information</span>
                            <svg class="ml-auto h-4 w-4 transition-transform group-hover:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                        <div id="info-section" class="ml-6 space-y-1 mt-2" style="display: none;">
                            <div class="p-2 rounded-lg hover:bg-sidebar-accent transition-colors cursor-pointer" onclick="setActivePage('dashboard_details')">
                                <span class="text-sm">Dashboard Details</span>
                            </div>
                            <div class="p-2 rounded-lg hover:bg-sidebar-accent transition-colors cursor-pointer" onclick="setActivePage('dashboard_faq')">
                                <span class="text-sm">Dashboard FAQ</span>
                            </div>
                        </div>
                    </div>

                     Notifications 
                    <div class="p-3 rounded-lg hover:bg-sidebar-accent transition-colors cursor-pointer" onclick="setActivePage('notifications')">
                        <div class="flex items-center gap-3">
                            <svg class="h-5 w-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM10.07 2.82l3.12 3.12M7.05 5.84L3.93 2.72M2 12h3M5.84 16.95l3.12-3.12M12 2v3M16.95 5.84l3.12-3.12M22 12h-3M16.95 16.95l-3.12 3.12"></path>
                            </svg>
                            <span class="font-medium">Notifications</span>
                        </div>
                    </div>
                </div>
            </div>

             Sidebar Footer 
            <div class="border-t border-sidebar-border p-4">
                <div class="flex items-center justify-center gap-3 p-3 rounded-lg bg-slate-50">
                    <img src="{{ url_for('static', filename='logo-icon-big.jpeg') }}" alt="UpStart13" class="h-8 w-8 rounded">
                    <div class="text-xs">
                        <div class="font-medium text-sidebar-foreground">Powered by</div>
                        <div class="text-primary font-semibold">Upstart13</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

     Main Content 
    <div class="flex-1 flex flex-col min-w-0">
         Header 
        <header class="sticky top-0 z-50 bg-background border-b border-border h-16 flex-shrink-0">
            <div class="flex h-full items-center justify-between px-4 sm:px-6">
                <div class="flex items-center gap-2 sm:gap-4 min-w-0">
                    <button onclick="toggleSidebar()" class="lg:hidden flex items-center justify-center p-2 hover:bg-muted rounded-lg transition-colors">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 id="page-title" class="text-lg sm:text-xl font-semibold text-foreground truncate">Expectant Mother Dashboard</h1>
                </div>

                <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0">
                    <div class="dropdown relative" id="user-dropdown">
                        <div onclick="toggleDropdown('user-dropdown')" class="flex items-center gap-3 p-2 rounded-lg border border-border bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors">
                            <img src="{{ url_for('static', filename='user-profile-avatar.png') }}" alt="Profile" class="h-8 w-8 rounded-full">
                            <div class="hidden sm:block text-sm">
                                <div class="font-medium">{{ user.name }}</div>
                                <div class="text-muted-foreground text-xs">{{ user.email }}</div>
                            </div>
                            <svg class="h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div class="dropdown-content">
                            <div class="dropdown-item text-red-600 hover:text-red-700 hover:bg-red-50" onclick="window.location.href='{{ url_for('logout') }}'">
                                Logout
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

         Dashboard Content 
        <div class="flex-1 flex flex-col p-3 sm:p-6 bg-popover overflow-auto">
             Controls Card 
            <div id="controls-card" class="p-4 sm:p-6 mb-4 sm:mb-6 border border-border bg-popover rounded-lg">
                <div class="flex flex-col gap-4">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div id="page-controls" class="flex flex-col sm:flex-row sm:flex-wrap items-stretch sm:items-center gap-3">
                             Controls will be populated by JavaScript 
                        </div>
                        <button onclick="toggleFullscreen()" class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors self-start sm:self-auto bg-transparent border border-border rounded px-3 py-2 text-sm">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                            </svg>
                            <span class="hidden sm:inline">Expandir</span>
                        </button>
                    </div>
                </div>
            </div>

             Fullscreen Menu (hidden by default) 
            <div id="fullscreen-menu" class="fixed top-0 left-0 right-0 z-[10000] bg-background/95 backdrop-blur-sm border-b border-border" style="display: none;">
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-center gap-2 sm:gap-4 p-3 sm:p-4">
                    <div id="fullscreen-controls">
                         Fullscreen controls will be populated by JavaScript 
                    </div>
                </div>
            </div>

             Main Content Card 
            <div id="iframe-container" class="flex-1 overflow-hidden border border-border min-h-0 bg-background rounded-lg">
                <div id="main-content" class="w-full h-full">
                    <iframe id="dashboard-iframe" 
                            src="about:blank" 
                            title="Gladney Dashboard" 
                            class="w-full h-full border-0 rounded-lg"
                            loading="lazy"
                            referrerpolicy="no-referrer-when-downgrade"
                            sandbox="allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox">
                    </iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 'expectant_mother';
let selectedGroup = '{{ selected_group }}';
let selectedView = '{{ selected_view }}';

// Page management
function setActivePage(page) {
    currentPage = page;
    updatePageTitle();
    updatePageControls();
    updateIframe();
    
    // Close sidebar on mobile
    if (window.innerWidth < 1024) {
        document.getElementById('sidebar').classList.add('sidebar-collapsed');
    }
}

function updatePageTitle() {
    const titles = {
        'expectant_mother': 'Expectant Mother Dashboard',
        'gladney_business': 'Gladney Business Performance Dashboard',
        'page_traffic': 'Page Traffic Monitor Dashboard',
        'dashboard_faq': 'Dashboard FAQ',
        'dashboard_details': 'Dashboard Details',
        'notifications': 'Notifications'
    };
    document.getElementById('page-title').textContent = titles[currentPage] || 'Dashboard';
}

function updatePageControls() {
    const controlsContainer = document.getElementById('page-controls');
    const fullscreenContainer = document.getElementById('fullscreen-controls');
    
    let controlsHTML = '';
    
    if (currentPage === 'expectant_mother') {
        controlsHTML = `
            <div class="dropdown relative" id="expectant-dropdown">
                <button onclick="toggleDropdown('expectant-dropdown')" class="flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
                    <span>Expectant Mother</span>
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="dropdown-content">
                    <div class="dropdown-item" onclick="selectView('expectant', 'overview_ads')">Overview - ads & hubspot</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'overview_ga4')">Overview - GA4</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'recent')">Recent Perspective</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'google_ads')">Google Ads Performance</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'campaign_break')">Campaign Breakdown</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'campaign_costs')">Campaign Costs</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'contact_cost')">Contact x Cost</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'day_of_week')">Day of the Week</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'campaign_ratios')">Campaign Ratios</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'contact_break')">Contact Breakdown</div>
                    <div class="dropdown-item" onclick="selectView('expectant', 'spam_break')">Spam Breakdown</div>
                </div>
            </div>
            <div class="dropdown relative" id="marketing-dropdown">
                <button onclick="toggleDropdown('marketing-dropdown')" class="flex items-center gap-2 px-4 py-2 border border-border rounded-lg hover:bg-muted transition-colors">
                    <span>Marketing Performance</span>
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="dropdown-content">
                    <div class="dropdown-item" onclick="selectView('marketing', 'performance_time')">Performance over time</div>
                    <div class="dropdown-item" onclick="selectView('marketing', 'cost_per')">Cost perâ€¦</div>
                    <div class="dropdown-item" onclick="selectView('marketing', 'table_download')">Table for download</div>
                    <div class="dropdown-item" onclick="selectView('marketing', 'enroll_placements')">Filter by Placements in Sugar</div>
                    <div class="dropdown-item" onclick="selectView('marketing', 'enroll_admission')">Filter by Admission in Sugar</div>
                    <div class="dropdown-item" onclick="selectView('marketing', 'enroll_creation')">Filter by Creation in Hubspot</div>
                    <div class="dropdown-item" onclick="selectView('marketing', 'enroll_timeseries')">Time Series</div>
                </div>
            </div>
        `;
        selectedGroup = 'expectant';
        selectedView = 'overview_ads';
    } else if (currentPage === 'gladney_business') {
        controlsHTML = `
            <div class="dropdown relative" id="domestic-dropdown">
                <button onclick="toggleDropdown('domestic-dropdown')" class="flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
                    <span>Domestic Infant</span>
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="dropdown-content">
                    <div class="dropdown-item" onclick="selectView('gladney', 'adoptive_performance')">Adoptive Parents - Performance</div>
                    <div class="dropdown-item" onclick="selectView('gladney', 'adoptive_recent')">Adoptive Parents - Recent</div>
                    <div class="dropdown-item" onclick="selectView('gladney', 'adoptive_timeline')">Adoptive Parents - Timeline</div>
                    <div class="dropdown-item" onclick="selectView('gladney', 'birth_overall')">Birth Parents - Overall</div>
                    <div class="dropdown-item" onclick="selectView('gladney', 'birth_detailed')">Birth Parents - Detailed</div>
                    <div class="dropdown-item" onclick="selectView('gladney', 'birth_recent')">Birth Parents - Recent</div>
                    <div class="dropdown-item" onclick="selectView('gladney', 'birth_breakdown')">Birth Parents - Breakdown</div>
                    <div class="dropdown-item" onclick="selectView('gladney', 'birth_timeline')">Birth Parents - Timeline</div>
                </div>
            </div>
        `;
        selectedGroup = 'gladney';
        selectedView = 'adoptive_performance';
    } else if (currentPage === 'page_traffic') {
        controlsHTML = `
            <button onclick="selectView('traffic', 'cover_page')" class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
                Cover Page
            </button>
            <button onclick="selectView('traffic', 'traffic_user_overview')" class="px-4 py-2 border border-border rounded-lg hover:bg-muted transition-colors">
                Traffic & User Overview
            </button>
            <div class="dropdown relative" id="traffic-dropdown">
                <button onclick="toggleDropdown('traffic-dropdown')" class="flex items-center gap-2 px-4 py-2 border border-border rounded-lg hover:bg-muted transition-colors">
                    <span>Traffic Analysis</span>
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="dropdown-content">
                    <div class="dropdown-item" onclick="selectView('traffic', 'sessions_overview')">Sessions Overview</div>
                    <div class="dropdown-item" onclick="selectView('traffic', 'user_overview')">User Overview</div>
                    <div class="dropdown-item" onclick="selectView('traffic', 'google_ads_keywords')">Google Ads Keywords</div>
                    <div class="dropdown-item" onclick="selectView('traffic', 'demographic_info')">Demographic Information</div>
                </div>
            </div>
        `;
        selectedGroup = 'traffic';
        selectedView = 'cover_page';
    }
    
    controlsContainer.innerHTML = controlsHTML;
    fullscreenContainer.innerHTML = controlsHTML;
    
    // Hide controls card for special pages
    const controlsCard = document.getElementById('controls-card');
    if (['dashboard_faq', 'dashboard_details', 'notifications'].includes(currentPage)) {
        controlsCard.style.display = 'none';
    } else {
        controlsCard.style.display = 'block';
    }
}

function selectView(group, view) {
    selectedGroup = group;
    selectedView = view;
    updateIframe();
    
    // Close all dropdowns
    document.querySelectorAll('.dropdown').forEach(d => {
        d.classList.remove('active');
    });
}

function updateIframe() {
    const iframe = document.getElementById('dashboard-iframe');
    const mainContent = document.getElementById('main-content');
    
    if (['dashboard_faq', 'dashboard_details', 'notifications'].includes(currentPage)) {
        // Show special content instead of iframe
        if (currentPage === 'notifications') {
            mainContent.innerHTML = `
                <div class="w-full h-full flex items-center justify-center p-8 bg-background">
                    <div class="text-center">
                        <div class="mb-6">
                            <img src="${'{{ url_for("static", filename="no-notification.png") }}'}" alt="No Notifications" class="w-32 h-auto mx-auto opacity-80">
                        </div>
                        <h3 class="text-2xl font-semibold text-gray-800 mb-2">No Notifications</h3>
                        <p class="text-gray-600 text-lg">You're all caught up!</p>
                    </div>
                </div>
            `;
        } else {
            // For FAQ and Details, you would add the content here
            mainContent.innerHTML = `
                <div class="w-full h-full p-8 bg-background overflow-auto">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">${currentPage === 'dashboard_faq' ? 'Dashboard FAQ' : 'Dashboard Details'}</h2>
                        <p class="text-muted-foreground">Content for ${currentPage} would go here.</p>
                    </div>
                </div>
            `;
        }
    } else {
        // Show iframe
        mainContent.innerHTML = `
            <iframe id="dashboard-iframe" 
                    src="about:blank" 
                    title="Gladney Dashboard" 
                    class="w-full h-full border-0 rounded-lg"
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade"
                    sandbox="allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox">
            </iframe>
        `;
        
        // Fetch iframe URL
        fetch(`/api/iframe_url?group=${selectedGroup}&view=${selectedView}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('dashboard-iframe').src = data.url;
            })
            .catch(error => {
                console.error('Error fetching iframe URL:', error);
            });
    }
}

function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section.style.display === 'none') {
        section.style.display = 'block';
    } else {
        section.style.display = 'none';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setActivePage('expectant_mother');
});
</script>
{% endblock %}
